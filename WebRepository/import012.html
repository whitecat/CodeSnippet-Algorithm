<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns:daisyutil="xalan://org.outerj.daisy.frontend.util.XslUtil" xmlns:urlencoder="xalan://java.net.URLEncoder" xmlns:i18n="http://apache.org/cocoon/i18n/2.1" xmlns:n="http://outerx.org/daisy/1.0#navigation" xmlns:d="http://outerx.org/daisy/1.0">
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Import private key and certificate into Java Key Store (JKS)</title>
<link href="/resources/skins/agentbob/css/daisy.css" type="text/css" rel="stylesheet">
<link media="screen" href="/resources/skins/agentbob/css/slimbox.css" type="text/css" rel="stylesheet">
<script>
          var daisy;
          if (!daisy) daisy = new Object();
          daisy.mountPoint = "";
          daisy.skin = "agentbob";
          
            daisy.site = {};
            daisy.site.name = "agentbob";
            daisy.site.branch = "main";
            daisy.site.branchId = "1";
            daisy.site.language = "en";
            daisy.site.languageId = "1";
          
          daisy.user = {};
          daisy.user.id = "101";
          daisy.user.login = "guest";
        </script><script xmlns:cinclude="http://apache.org/cocoon/include/1.0" xmlns:p="http://outerx.org/daisy/1.0#publisher" type="text/javascript" src="/resources/skins/agentbob/js/mootools-release-1.11.js"></script><script type="text/javascript" src="/resources/skins/agentbob/js/slimbox.js"></script><script src="/resources/js/daisy.js" type="text/javascript"></script><script src="/resources/skins/agentbob/js/menu.js" type="text/javascript"></script>
</head>
<body onUnload="if (typeof GUnload == 'function') GUnload();">
<div class="container">
<div parseWidgets="false" id="header">
<div class="logo">
<a href="/agentbob/"><img src="/resources/skins/agentbob/images/bob.png"></a>
</div>
<div id="siteNavigation">
<a href="/agentbob/">Site Home</a>
</div>
<div id="search">
<form action="/agentbob/search">
<input id="searchInput" name="query" type="text"> <input id="searchButton" value="Search" type="submit">
</form>
</div>
</div>
<div class="section">
<div parseWidgets="false" class="raised" id="generalNavigation">
<b class="top"><b class="b1"></b><b class="b2"></b><b class="b3"></b><b class="b4"></b></b>
<div class="boxcontent">
<span>&nbsp;</span>
<ul class="tabNavigation">
<li>
<a class="menuLink" onmouseover="status=''; return true;" href="#">User: guest</a>
<ul>
<li class="tabNavigation">
<a href="/login?returnTo=%2Fagentbob%2F79-AB.html">Change login</a>
</li>
<li class="tabNavigation">
<a href="/registration?returnTo=%2Fagentbob%2F79-AB.html">Register</a>
</li>
<li class="tabNavigation">
<a href="/locale?returnTo=%2Fagentbob%2F79-AB.html">Change locale</a>
</li>
</ul>
</li>
<li class="tabNavigation">
<a class="menuLink" onmouseover="status=''; return true;" href="#">Role: guest</a>
<ul>
<li class="tabNavigation">
<form style="display: none" method="POST" action="/login?action=changeRole&newrole=101&returnTo=%2Fagentbob%2F79-AB.html" id="N10066"></form>
<a onmouseover="status=''; return true;" onclick="document.getElementById('N10066').submit(); return false;" href="#" class="">guest</a>
</li>
</ul>
</li>
</ul>
</div>
<b class="bottom"><b class="b4b"></b><b class="b3b"></b><b class="b2b"></b><b class="b1b"></b></b>
</div>
<div id="content">
<h1 xmlns:einclude="http://outerx.org/daisy/1.0#externalinclude" xmlns:lt="http://outerx.org/daisy/1.0#linktransformer" id="dsy79-AB" class="daisy-document-name">Import private key and certificate into Java Key Store (JKS)</h1>


<p xmlns:jx="http://apache.org/cocoon/templates/jx/1.0" xmlns:ns="http://outerx.org/daisy/1.0">Apache Tomcat and many other Java applications expect to retrieve SSL/TLS
certificates from a Java Key Store (JKS). Jave Virtual Machines usually come
with
<a href="http://java.sun.com/j2se/1.5.0/docs/tooldocs/windows/keytool.html" target="_blank">keytool&nbsp;<img src="/static/img/external.png"></a>
to help you create a new key store.</p>


<p>Keytool helps you to:</p>


<ul>

<li>create a new JKS with a new private key</li>

<li>generate a Certificate Signung Request (CSR) for the private key in this JKS
</li>

<li>import a certificate that you received for this CSR into your JKS</li>

</ul>


<p>Keytool <strong>does not</strong> let you import an existing private key for
which you already have a certificate. So you need to do this yourself, here's
how:</p>


<p>Let's assume you have a private key (<strong>key.pem</strong>) and a
certificate (<strong>cert.pem</strong>), both in PEM format as the file names
suggest.</p>


<p>PEM format is 'kind-of-human-readable' and looks like e.g.</p>


<pre>-----BEGIN CERTIFICATE-----
Ulv6GtdFbjzLeqlkelqwewlq822OrEPdH+zxKUkKGX/eN
.
. (snip)
.
9801asds3BCfu52dm7JHzPAOqWKaEwIgymlk=
----END CERTIFICATE-----
</pre>


<p>Convert both, the key and the certificate into DER format using
<a href="http://www.openssl.org/" target="_blank">openssl&nbsp;<img src="/static/img/external.png"></a>:</p>


<pre>openssl pkcs8 -topk8 -nocrypt -in key.pem -inform PEM -out key.der -outform DER
openssl x509 -in cert.pem -inform PEM -out cert.der -outform DER</pre>


<p>Now comes the tricky bit, you need something to import these files into the
JKS. ImportKey will do this for you, get the
<a title="ImportKey.java" href="/agentbob/80/version/default/part/AttachmentData/data/ImportKey.java">ImportKey.java</a> (text/x-java-source, 6.6 kB, <a href="/agentbob/80.html">info</a>) source or the compiled (Java 1.5 !)
<a title="ImportKey.class" href="/agentbob/81/version/default/part/AttachmentData/data/ImportKey.class">ImportKey.class</a> (application/octet-stream, 3.3 kB, <a href="/agentbob/81.html">info</a>) and run it like</p>


<pre>user@host:~$ <strong>java ImportKey key.der cert.der</strong>
Using keystore-file : /home/user/keystore.ImportKey
One certificate, no chain.
Key and certificate stored.
Alias:importkey  Password:importkey
</pre>


<p>Now we have a proper JKS containing our private key and certificate in a file
called keystore.ImportKey, using 'importkey' as alias and also as password. For
any further changes, like changing the password we can use keytool.</p>


<div id="commentContainer">
<div class="corner">
<span><a onclick="document.getElementById('comments').style.display=''; document.getElementById('showCommentsLink').style.display='none'; return false;" onmouseover="window.status=''; return true;" href="#" id="showCommentsLink"> Comments
            (9)
          </a></span><a name="daisycomments"></a>
<div id="comments" class="comments" style="display: none">
<span class="commentsTitle">Comments</span> <a onclick="document.getElementById('comments').style.display='none'; document.getElementById('showCommentsLink').style.display=''; return false;" onmouseover="window.status=''; return true;" href="#">Hide</a>
<br>
<a name="daisycomment10"></a>
<div class="comment publicComment">
<table width="100%" class="plainTable">
<tr>
<td>
<div class="commentheader">Created by Marco Massenzio on 3/20/07 2:32:56 AM</div>
</td><td align="right"><span class="commentVisibility"></span> <span class="commentActions"></span></td>
</tr>
</table>
<div class="commentbody">
<ns:content>Hello,<br>
<br>this is exactly what I needed, as I have obtained a developer certificate from Symbian, but the cert request gen tool is a Symbian custom app, and thus generates its own private key.<br>
<br>However, the key it generates, does not appear to be in valid PEM format (at least according to openssl that complains about it):<br>
<br>D:\&gt;d:\OpenSSL\bin\openssl pkcs8 -nocrypt -in ibw2.pem -inform PEM -out ibw2.der -outform DER<br>Enter PEM pass phrase:<br>Error decrypting key<br>4236:error:0D0680A8:asn1 encoding routines:ASN1_CHECK_TLEN:wrong tag:.\crypto\asn1\tasn_dec.c:1294:<br>4236:error:0D07803A:asn1 encoding routines:ASN1_ITEM_EX_D2I:nested asn1 error:.\crypto\asn1\tasn_dec.c:380:Type=X509_ALG<br>OR<br>4236:error:0D08303A:asn1 encoding routines:ASN1_TEMPLATE_NOEXP_D2I:nested asn1 error:.\crypto\asn1\tasn_dec.c:749:Field=<br>pkeyalg, Type=PKCS8_PRIV_KEY_INFO<br>4236:error:0906700D:PEM routines:PEM_ASN1_read_bio:ASN1 lib:.\crypto\pem\pem_oth.c:83:<br>
<br>
<br>The key (well, not all of it) is something like this:<br>-----BEGIN RSA PRIVATE KEY-----<br>Proc-Type: 4,ENCRYPTED<br>DEK-Info: DES-EDE3-CBC,C83F3B63FAD97DA6<br>
<br>TYnfdy/1XQAtAL/R1gVGk1S0DLjXre8BK6fe6tLOzTLIxxczCVQjF9exPqjFypE7<br>uH9EleWc+7TLHkvN2QLtcG6wXewvHexhcjwjN3MiThrFB29BVDMgHyGf9ZHVUUqs<br>...<br>tZJeSwNF0lPJ6/wwwUeyaOJCu0xCSvhMCZ9FBaZgdX+a2s40Kqb/kiQlWPKoNqF6<br>gAz2xettQCCIV18c7fzHqXeHXics66Tau+3MpG3tN3o6efvJgQU7vw==<br>-----END RSA PRIVATE KEY-----<br>
<br>I am somewhat stuck in that I can't EXPORT the key from keytool to use in the CSR generator (from Symbian) and I can't import the key/certificate as obtained from Symbian.<br>
<br>Kinda Catch-22....<br>
<br>If you have any suggestions that would be massively appreciated, thanks<br>Marco<br>admin@infinitebw.com<br>
<br>
</ns:content>
</div>
</div>
<a name="daisycomment16"></a>
<div class="comment publicComment">
<table width="100%" class="plainTable">
<tr>
<td>
<div class="commentheader">Created by Barry Simons on 4/5/07 2:28:36 AM</div>
</td><td align="right"><span class="commentVisibility"></span> <span class="commentActions"></span></td>
</tr>
</table>
<div class="commentbody">
<ns:content>I encountered a problem when importing a chained SSL cert. To solve this problem, I changed certs = (Certificate[])c.toArray(); (line 147) to<br>int i = 0;<br>Iterator it = c.iterator();<br>while (it.hasNext()) {<br>    certs[i] = (Certificate)it.next();<br>    i++;<br>}<br>
<br>Next, I converted all SSL certs from PEM to DER and cat my cert, intermediate cert, and root cert into certs.der. After that, everything worked great.<br>
<br>Hope this helps anyone working with chained certs</ns:content>
</div>
</div>
<a name="daisycomment17"></a>
<div class="comment publicComment">
<table width="100%" class="plainTable">
<tr>
<td>
<div class="commentheader">Created by Barry Simons on 4/5/07 2:31:52 AM</div>
</td><td align="right"><span class="commentVisibility"></span> <span class="commentActions"></span></td>
</tr>
</table>
<div class="commentbody">
<ns:content>Marco,<br>
<br>I am not sure if this helps, but try adding -topk8 when converting. Hope this helps.<br>
<br>Barry</ns:content>
</div>
</div>
<a name="daisycomment18"></a>
<div class="comment publicComment">
<table width="100%" class="plainTable">
<tr>
<td>
<div class="commentheader">Created by johann renck on 9/3/07 3:31:49 PM</div>
</td><td align="right"><span class="commentVisibility"></span> <span class="commentActions"></span></td>
</tr>
</table>
<div class="commentbody">
<ns:content>Barry, In my CA's instructions they say that I need to import an intermediate cert, so following your instructions (BTW you just need to put certs = (Certificate[])c.toArray(new Certificate[0]);) I created the following shell script:<br>
<br>THE_NAME=name.dummy.com<br>export THE_NAME<br>
<br>openssl pkcs8 -topk8 -nocrypt -in ${THE_NAME}_key.pem -inform PEM -out ${THE_NAME}_key.der -outform DER<br>
<br>openssl x509 -in intermediateCA_cer.pem -inform PEM -out intermediateCA_cer.der -outform DER<br>
<br>openssl x509 -in ${THE_NAME}_cer.pem -inform PEM -out ${THE_NAME}_cer.der -outform DER<br>
<br>cat intermediateCA_cer.der ${THE_NAME}_cer.der &gt; ${THE_NAME}_all_cer.der<br>
<br>javac *.java<br>
<br>java ImportKey ${THE_NAME}_key.der ${THE_NAME}_all_cer.der<br>
<br>keytool -list<br>
<br>But the keystore ony shows one entry, any ideas why is this happening?<br>
<br>Thanks,<br>
<br>Johann</ns:content>
</div>
</div>
<a name="daisycomment19"></a>
<div class="comment publicComment">
<table width="100%" class="plainTable">
<tr>
<td>
<div class="commentheader">Created by johann renck on 9/3/07 9:49:12 PM</div>
</td><td align="right"><span class="commentVisibility"></span> <span class="commentActions"></span></td>
</tr>
</table>
<div class="commentbody">
<ns:content>Ok, now it's working.<br>What I did was:<br>
<br>changed certs = (Certificate[])c.toArray(); (line 147) to<br>(Certificate[])c.toArray(new Certificate[0]);<br>
<br>Then I ran the following script:<br>
<br>JAVA_HOME=/usr/java/latest<br>export JAVA_HOME<br>
<br>PATH=$JAVA_HOME/bin:$PATH<br>export PATH<br>
<br>THE_NAME=www.dummy.org<br>export THE_NAME<br>
<br>rm /root/.keystore<br>rm /usr/share/tomcat5/.keystore<br>
<br>openssl pkcs8 -topk8 -nocrypt -in ${THE_NAME}_key.pem -inform PEM -out ${THE_NAME}_key.der -outform DER<br>
<br>openssl x509 -in rootCA_cer.pem -inform PEM -out rootCA_cer.der -outform DER<br>
<br>openssl x509 -in intermediateCA_cer.pem -inform PEM -out intermediateCA_cer.der -outform DER<br>
<br>openssl x509 -in ${THE_NAME}_cer.pem -inform PEM -out ${THE_NAME}_cer.der -outform DER<br>
<br>cat ${THE_NAME}_cer.der intermediateCA_cer.der rootCA_cer.der &gt; ${THE_NAME}_all_cer.der<br>
<br>javac *.java<br>
<br>java ImportKey ${THE_NAME}_key.der ${THE_NAME}_all_cer.der<br>
<br>cp /root/keystore.ImportKey /root/.keystore<br>
<br>cp /root/.keystore /usr/share/tomcat5/.keystore<br>
<br>keytool -keypass changeit -storepass changeit -list</ns:content>
</div>
</div>
<a name="daisycomment20"></a>
<div class="comment publicComment">
<table width="100%" class="plainTable">
<tr>
<td>
<div class="commentheader">Created by Ian Stokes-Rees on 4/10/08 12:00:50 AM</div>
</td><td align="right"><span class="commentVisibility"></span> <span class="commentActions"></span></td>
</tr>
</table>
<div class="commentbody">
<ns:content>ImportKey.java is actually a .class file.  Would it be possible to update it to the source code again?</ns:content>
</div>
</div>
<a name="daisycomment21"></a>
<div class="comment publicComment">
<table width="100%" class="plainTable">
<tr>
<td>
<div class="commentheader">Created by Chris Markle on 12/17/08 12:56:28 AM</div>
</td><td align="right"><span class="commentVisibility"></span> <span class="commentActions"></span></td>
</tr>
</table>
<div class="commentbody">
<ns:content>Hello,<br>
<br>Thank you VERY much for this post and this Java code. And thanks to the others for their further comments and updates to the code.<br>
<br>I needed to build a cert that had three other intermediate certs combined with it. I pretty much did (manually) what johann did in hist second post and all worked perfectly.<br>
<br>Thanks to all of you for this valuable post.<br>
<br>Chris</ns:content>
</div>
</div>
<a name="daisycomment22"></a>
<div class="comment publicComment">
<table width="100%" class="plainTable">
<tr>
<td>
<div class="commentheader">Created by Eldad Dudu on 3/3/09 11:48:57 AM</div>
</td><td align="right"><span class="commentVisibility"></span> <span class="commentActions"></span></td>
</tr>
</table>
<div class="commentbody">
<ns:content>I have a key.pem and cert.pem and I did as <br>instructed, it did created the file in my %User% home dir<br>but when I run Keytool -list, it doesn't find the file.<br>I tried a bunch of parameters ( like -file "C:\..." and so on)<br>
<br>I'm working inside a Novell network, does it matter????<br>
<br>I'm only asking cause I've encountered a post somewhere<br>that someone needed his IT people to delete and recreate<br>his User account in a Windows ENV to make the<br>Keytool -list to work<br>
<br>any information will be more then appreciated .<br>
<br>Ely.</ns:content>
</div>
</div>
<a name="daisycomment23"></a>
<div class="comment publicComment">
<table width="100%" class="plainTable">
<tr>
<td>
<div class="commentheader">Created by John Blakely on 10/7/09 5:08:36 PM</div>
</td><td align="right"><span class="commentVisibility"></span> <span class="commentActions"></span></td>
</tr>
</table>
<div class="commentbody">
<ns:content>Is there a way to export the created signing key to add it to an existing keystore?</ns:content>
</div>
</div>
<div class="addCommentTitle">Add a comment</div>
<div class="addComment">Please log in to be able to add comments.</div>
</div>
</div>
</div>
</div>
<div style="margin: 4px;  margin-left: 65em;  position:absolute;  top: 100px; margin-top: 3em; width: 128px;" id="googleAd">
<script type="text/javascript">
        google_ad_client = "pub-5838510440623566"; google_ad_slot = "8318554177"; google_ad_width = 120; google_ad_height = 600;
      </script><script src="http://pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript"></script>
</div>
</div>
<div parseWidgets="false" id="documentNavigation">
<ul class="navigation">
<li class="navigation ">
<a href="/agentbob/2-AB.html" class="navigation ">Home</a>
</li>
<li class="navigation ">
<a href="/agentbob/22-AB.html" class="navigation ">Services Offered</a>
</li>
<li class="navigation ">
<a href="/agentbob/53-AB.html" class="navigation ">Clients</a>
</li>
<li class="navigation ">
<a href="/agentbob/23-AB.html" class="navigation ">Contact &amp; Legal</a>
</li>
<li class="navigation navgroup-clickable navnode-closed">
<a class="navigation navgroup-clickable navnode-closed" href="/agentbob/g2">PeopleSoft</a>
</li>
<li class="navigation navgroup-clickable navnode-closed">
<a class="navigation navgroup-clickable navnode-closed" href="/agentbob/Oracle">Oracle</a>
</li>
<li class="navigation navgroup-clickable navnode-closed">
<a class="navigation navgroup-clickable navnode-closed" href="/agentbob/g3">Debian Linux Notes</a>
</li>
<li class="navigation navgroup-clickable navnode-closed">
<a class="navigation navgroup-clickable navnode-closed" href="/agentbob/g4">Fighting Spam - Agent Bob strikes back</a>
</li>
<li class="navigation active-navnode">
<a href="/agentbob/79-AB.html" class="navigation active-navnode">Import private key and certificate into Java Key Store (JKS)</a>
</li>
<li class="navigation navgroup-clickable navnode-closed">
<a class="navigation navgroup-clickable navnode-closed" href="/agentbob/Links">Links</a>
</li>
</ul>
</div>
</div>
<div id="extraBottomContent"></div>
</body>
</html>
